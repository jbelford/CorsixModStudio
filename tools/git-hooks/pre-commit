#!/bin/sh
# Pre-commit hook: verify staged C++ files under src/ are clang-formatted.
# Install with:  git config core.hooksPath tools/git-hooks

# ── Locate clang-format ────────────────────────────────────────────────────
find_clang_format() {
    # 1. Check PATH
    if command -v clang-format >/dev/null 2>&1; then
        echo "clang-format"
        return
    fi

    # 2. Check common Visual Studio install locations (Windows)
    for vs in \
        "/c/Program Files/Microsoft Visual Studio/"*/*/VC/Tools/Llvm/x64/bin/clang-format.exe \
        "/c/Program Files/Microsoft Visual Studio/"*/*/VC/Tools/Llvm/bin/clang-format.exe \
        "/c/Program Files (x86)/Microsoft Visual Studio/"*/*/VC/Tools/Llvm/bin/clang-format.exe
    do
        if [ -x "$vs" ]; then
            echo "$vs"
            return
        fi
    done
}

CLANG_FORMAT=$(find_clang_format)
if [ -z "$CLANG_FORMAT" ]; then
    echo "warning: clang-format not found — skipping format check"
    echo "  Install LLVM or add Visual Studio's clang-format to PATH"
    exit 0
fi

# ── Collect staged C++ files under src/ only ───────────────────────────────
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^src/.*\.(cpp|c|h|hpp)$')
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# ── Auto-format and re-stage ──────────────────────────────────────────
UNFORMATTED=""
for FILE in $STAGED_FILES; do
    if ! "$CLANG_FORMAT" --dry-run --Werror "$FILE" >/dev/null 2>&1; then
        "$CLANG_FORMAT" -i "$FILE"
        git add "$FILE"
        UNFORMATTED="$UNFORMATTED  $FILE\n"
    fi
done

if [ -n "$UNFORMATTED" ]; then
    echo "clang-format: auto-formatted and re-staged:"
    printf "$UNFORMATTED"
fi

exit 0
